YPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¶²èª²æˆæ¬Šç¢¼ç®¡ç†ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .glass { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .video-active { border-color: #3b82f6; background-color: #eff6ff; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen text-slate-800">

    <div id="app" class="max-w-5xl mx-auto p-4 md:p-8">
        <!-- å°èˆªåˆ— -->
        <nav class="flex space-x-4 mb-8 border-b border-slate-200">
            <button onclick="switchTab('client')" id="btn-client" class="pb-2 px-4 font-bold border-b-2 border-blue-500 text-blue-600">èª²ç¨‹ç™»å…¥</button>
            <button onclick="switchTab('admin')" id="btn-admin" class="pb-2 px-4 font-bold text-slate-500 hover:text-blue-500">å¾Œå°ç®¡ç†</button>
        </nav>

        <!-- å®¢æˆ¶ç™»å…¥å€åŸŸ -->
        <div id="tab-client" class="tab-content active">
            <div id="login-section" class="glass p-8 rounded-2xl shadow-xl max-w-md mx-auto border border-white">
                <h2 class="text-2xl font-bold mb-6 text-center text-slate-700">å­¸å“¡ç™»å…¥èª²ç¨‹</h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-600 mb-1">è«‹è¼¸å…¥æˆæ¬Šç¢¼</label>
                        <input type="text" id="auth-code-input" class="w-full px-4 py-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 outline-none transition" placeholder="ä¾‹å¦‚: ABCD-1234">
                    </div>
                    <button id="login-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg shadow-lg transition transform active:scale-95">
                        é–‹å§‹ä¸Šèª²
                    </button>
                    <p id="login-msg" class="text-center text-sm mt-4"></p>
                </div>
            </div>

            <!-- èª²ç¨‹å…§å®¹å€åŸŸ (ç™»å…¥å¾Œé¡¯ç¤º) -->
            <div id="course-content" class="hidden grid grid-cols-1 lg:grid-cols-3 gap-8 mt-8">
                <!-- å·¦å´ï¼šå½±ç‰‡æ’­æ”¾èˆ‡æè¿° -->
                <div class="lg:col-span-2 space-y-6">
                    <div class="bg-white p-4 rounded-2xl shadow-lg border border-slate-100">
                        <div id="player-container" class="aspect-video bg-black rounded-xl overflow-hidden shadow-inner">
                            <!-- é è¨­æ’­æ”¾ç¬¬ä¸€èª² -->
                            <iframe id="main-video-player" width="100%" height="100%" src="" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                        </div>
                        <div class="mt-6">
                            <h2 id="current-video-title" class="text-2xl font-bold text-slate-800">è¼‰å…¥ä¸­...</h2>
                            <p id="current-video-desc" class="text-slate-600 mt-2">è«‹å¾å³å´é¸æ“‡èª²ç¨‹é€²è¡Œè§€çœ‹ã€‚</p>
                        </div>
                    </div>
                </div>

                <!-- å³å´ï¼šèª²ç¨‹ç›®éŒ„åˆ—è¡¨ -->
                <div class="lg:col-span-1">
                    <div class="bg-white rounded-2xl shadow-lg border border-slate-100 overflow-hidden">
                        <div class="bg-slate-50 p-4 border-b">
                            <h3 class="font-bold flex items-center"><span class="mr-2">ğŸ“š</span> èª²ç¨‹ç›®éŒ„ (å…± 10 èª²)</h3>
                        </div>
                        <div id="course-list" class="divide-y divide-slate-100 max-h-[600px] overflow-y-auto">
                            <!-- èª²ç¨‹æ¸…å–®ç”± JS å‹•æ…‹ç”Ÿæˆ -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç®¡ç†å“¡å¾Œå°å€åŸŸ -->
        <div id="tab-admin" class="tab-content">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- ç”¢ç”Ÿæˆæ¬Šç¢¼ -->
                <div class="bg-white p-6 rounded-xl shadow-md border border-slate-100 col-span-1">
                    <h3 class="font-bold text-lg mb-4">ç”¢ç”Ÿæ–°æˆæ¬Šç¢¼</h3>
                    <div class="space-y-4">
                        <button id="gen-btn" class="w-full bg-emerald-500 hover:bg-emerald-600 text-white py-2 rounded shadow transition">
                            éš¨æ©Ÿç”¢ç”Ÿä¸€å€‹
                        </button>
                        <div id="new-code-display" class="p-3 bg-slate-100 rounded text-center font-mono font-bold text-blue-600 hidden"></div>
                    </div>
                </div>

                <!-- ç›£æ§åˆ—è¡¨ -->
                <div class="bg-white p-6 rounded-xl shadow-md border border-slate-100 col-span-2">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-lg">æˆæ¬Šç¢¼ä½¿ç”¨ç›£æ§</h3>
                        <button id="refresh-btn" class="text-sm text-blue-500 hover:underline">é‡æ–°æ•´ç†</button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-sm">
                            <thead>
                                <tr class="bg-slate-50 border-b">
                                    <th class="py-2 px-3">æˆæ¬Šç¢¼</th>
                                    <th class="py-2 px-3">ä½¿ç”¨æ¬¡æ•¸</th>
                                    <th class="py-2 px-3">æœ€å¾Œç™»å…¥æ™‚é–“</th>
                                    <th class="py-2 px-3">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="logs-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, deleteDoc, collection, getDocs, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase é…ç½®
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'course-app-001';

        // --- èª²ç¨‹è³‡æ–™è¨­å®šå€åŸŸ ---
        // è«‹åœ¨æ­¤è™•å¡«å…¥æ‚¨çš„ YouTube å½±ç‰‡ ID æˆ–é€£çµ
        const courseData = [
            { id: 1, title: "ç¬¬ä¸€èª²ï¼šä¸­è—¥é¤Šç”Ÿè‡ªç™‚å¸«åŸºç¤èª²ç¨‹", desc: "èªè­˜äº”è¡Œçš„æ ¸å¿ƒæ¦‚å¿µã€‚", videoUrl: "https://www.youtube.com/embed/https://youtu.be/WQYtYbTHsCI" },
            { id: 2, title: "ç¬¬äºŒèª²ï¼šä¸­è—¥é¤Šç”Ÿè‡ªç™‚å¸«åŸºç¤èª²ç¨‹", desc: "æ·±å…¥æ¢è¨æ™‚é–“æ²»ç™‚ã€‚", videoUrl: "https://www.youtube.com/embed/https://youtu.be/0Lv2giPQ_5Y" },
            { id: 3, title: "ç¬¬ä¸‰èª²ï¼šä¸­è—¥é¤Šç”Ÿè‡ªç™‚å¸«åŸºç¤èª²ç¨‹", desc: "å­¸ç¿’å››è¨ºæ–¹æ³•ã€‚", videoUrl: "https://www.youtube.com/embed/https://youtu.be/IHOx8ZqwnR4" },
            { id: 4, title: "ç¬¬å››èª²ï¼šä¸­è—¥é¤Šç”Ÿè‡ªç™‚å¸«åŸºç¤èª²ç¨‹", desc: "å…­æ·«ï¼ˆå…­ç¨®è‡´ç—…åŸå› ï¼‰ã€‚", videoUrl: "https://www.youtube.com/embed/https://youtu.be/L_qJQeA0_d4" },
            { id: 5, title: "ç¬¬äº”èª²ï¼šä¸­è—¥é¤Šç”Ÿè‡ªç™‚å¸«åŸºç¤èª²ç¨‹", desc: "ä¸ƒæƒ…ï¼ˆè‡´ç—…å…§å› ï¼‰ã€‚", videoUrl: "https://www.youtube.com/embed/https://youtu.be/qLRgpoLtaHo" },
            { id: 6, title: "ç¬¬å…­èª²ï¼šä¸­è—¥é¤Šç”Ÿè‡ªç™‚å¸«åŸºç¤èª²ç¨‹", desc: "æœªä¸Šæ¶ã€‚", videoUrl: "https://www.youtube.com/embed/å½±ç‰‡ID6" },
            { id: 7, title: "ç¬¬ä¸ƒèª²ï¼šä¸­è—¥é¤Šç”Ÿè‡ªç™‚å¸«åŸºç¤èª²ç¨‹", desc: "æœªä¸Šæ¶ã€‚", videoUrl: "https://www.youtube.com/embed/å½±ç‰‡ID7" },
            { id: 8, title: "ç¬¬å…«èª²ï¼šä¸­è—¥é¤Šç”Ÿè‡ªç™‚å¸«åŸºç¤èª²ç¨‹", desc: "æœªä¸Šæ¶ã€‚", videoUrl: "https://www.youtube.com/embed/å½±ç‰‡ID8" },
            { id: 9, title: "ç¬¬ä¹èª²ï¼šä¸­è—¥é¤Šç”Ÿè‡ªç™‚å¸«åŸºç¤èª²ç¨‹", desc: "æœªä¸Šæ¶ã€‚", videoUrl: "https://www.youtube.com/embed/å½±ç‰‡ID9" },
            { id: 10, title: "ç¬¬åèª²ï¼šä¸­è—¥é¤Šç”Ÿè‡ªç™‚å¸«åŸºç¤èª²ç¨‹", desc: "æœªä¸Šæ¶ã€‚", videoUrl: "https://www.youtube.com/embed/å½±ç‰‡ID10" }
        ];

        let currentUser = null;

        // åˆå§‹åŒ–é©—è­‰
        const initAuth = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Auth Error", error);
            }
        };

        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            if (user && document.getElementById('tab-admin').classList.contains('active')) {
                refreshLogs();
            }
        });

        // åˆ‡æ›åˆ†é 
        window.switchTab = (tab) => {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById(`tab-${tab}`).classList.add('active');
            
            const clientBtn = document.getElementById('btn-client');
            const adminBtn = document.getElementById('btn-admin');
            if(tab === 'client') {
                clientBtn.classList.add('border-b-2', 'border-blue-500', 'text-blue-600');
                adminBtn.classList.remove('border-b-2', 'border-blue-500', 'text-blue-600');
            } else {
                adminBtn.classList.add('border-b-2', 'border-blue-500', 'text-blue-600');
                clientBtn.classList.remove('border-b-2', 'border-blue-500', 'text-blue-600');
                if (currentUser) refreshLogs();
            }
        };

        // æ¸²æŸ“èª²ç¨‹æ¸…å–®
        const renderCourseList = () => {
            const listEl = document.getElementById('course-list');
            listEl.innerHTML = '';
            courseData.forEach((course, index) => {
                const item = document.createElement('div');
                item.className = `p-4 cursor-pointer hover:bg-slate-50 transition flex items-center ${index === 0 ? 'video-active' : ''}`;
                item.id = `course-item-${course.id}`;
                item.onclick = () => playVideo(course.id);
                item.innerHTML = `
                    <div class="w-8 h-8 rounded-full bg-slate-200 flex items-center justify-center text-xs font-bold mr-3 shrink-0">
                        ${course.id}
                    </div>
                    <div>
                        <div class="font-medium text-sm text-slate-800">${course.title}</div>
                    </div>
                `;
                listEl.appendChild(item);
            });
            // é è¨­æ’­æ”¾ç¬¬ä¸€å ‚èª²
            playVideo(courseData[0].id);
        };

        // æ’­æ”¾å½±ç‰‡å‡½æ•¸
        window.playVideo = (id) => {
            const course = courseData.find(c => c.id === id);
            if (!course) return;

            // æ›´æ–°æ’­æ”¾å™¨å…§å®¹
            document.getElementById('main-video-player').src = course.videoUrl;
            document.getElementById('current-video-title').innerText = course.title;
            document.getElementById('current-video-desc').innerText = course.desc;

            // æ›´æ–°åˆ—è¡¨ UI é¸å–ç‹€æ…‹
            document.querySelectorAll('#course-list > div').forEach(el => el.classList.remove('video-active'));
            document.getElementById(`course-item-${id}`).classList.add('video-active');
        };

        // å®¢æˆ¶ç™»å…¥
        const handleLogin = async () => {
            const code = document.getElementById('auth-code-input').value.trim().toUpperCase();
            const msgEl = document.getElementById('login-msg');

            if (!code) {
                showMessage(msgEl, "è«‹è¼¸å…¥æˆæ¬Šç¢¼", "text-red-500");
                return;
            }

            try {
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'licenses', code);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    await updateDoc(docRef, {
                        usageCount: (data.usageCount || 0) + 1,
                        lastLogin: Timestamp.now()
                    });

                    showMessage(msgEl, "é©—è­‰æˆåŠŸï¼", "text-green-500");
                    document.getElementById('login-section').classList.add('hidden');
                    document.getElementById('course-content').classList.remove('hidden');
                    renderCourseList();
                } else {
                    showMessage(msgEl, "ç„¡æ•ˆçš„æˆæ¬Šç¢¼ï¼Œè«‹è¯ç¹«å®¢æœã€‚", "text-red-500");
                }
            } catch (e) {
                console.error(e);
                showMessage(msgEl, "ç³»çµ±éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚", "text-red-500");
            }
        };

        // ç®¡ç†å“¡ï¼šç”¢ç”Ÿä»£ç¢¼
        const generateCode = async () => {
            if (!currentUser) return;
            const newCode = Array.from({length: 8}, () => "ABCDEFGHJKLMNPQRSTUVWXYZ23456789"[Math.floor(Math.random() * 32)]).join('');
            try {
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'licenses', newCode);
                await setDoc(docRef, {
                    code: newCode,
                    createdAt: Timestamp.now(),
                    usageCount: 0,
                    lastLogin: null,
                    status: 'active'
                });
                const display = document.getElementById('new-code-display');
                display.innerText = newCode;
                display.classList.remove('hidden');
                refreshLogs();
            } catch (e) { console.error(e); }
        };

        // ç®¡ç†å“¡ï¼šåˆ·æ–°æ¸…å–®
        const refreshLogs = async () => {
            if (!currentUser) return;
            const tableBody = document.getElementById('logs-table-body');
            tableBody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-slate-400">è¼‰å…¥ä¸­...</td></tr>';
            try {
                const colRef = collection(db, 'artifacts', appId, 'public', 'data', 'licenses');
                const querySnapshot = await getDocs(colRef);
                tableBody.innerHTML = '';
                querySnapshot.forEach((docSnap) => {
                    const data = docSnap.data();
                    const lastLoginStr = data.lastLogin ? data.lastLogin.toDate().toLocaleString('zh-TW') : 'å¾æœªç™»å…¥';
                    const tr = document.createElement('tr');
                    tr.className = "border-b hover:bg-slate-50";
                    tr.innerHTML = `
                        <td class="py-3 px-3 font-mono font-bold">${data.code}</td>
                        <td class="py-3 px-3">${data.usageCount} æ¬¡</td>
                        <td class="py-3 px-3 text-xs text-slate-500">${lastLoginStr}</td>
                        <td class="py-3 px-3">
                            <button onclick="deleteLicense('${data.code}')" class="text-red-500 hover:text-red-700">åˆªé™¤</button>
                        </td>
                    `;
                    tableBody.appendChild(tr);
                });
                if (querySnapshot.empty) tableBody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-slate-400">å°šç„¡æˆæ¬Šç¢¼æ•¸æ“š</td></tr>';
            } catch (e) { console.error(e); }
        };

        window.deleteLicense = async (code) => {
            if(!confirm(`ç¢ºå®šè¦åˆªé™¤æˆæ¬Šç¢¼ ${code}ï¼Ÿ`)) return;
            try {
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'licenses', code);
                await deleteDoc(docRef);
                refreshLogs();
            } catch (e) { console.error(e); }
        };

        function showMessage(el, text, colorClass) {
            el.innerText = text;
            el.className = `text-center text-sm mt-4 ${colorClass}`;
        }

        document.getElementById('login-btn').addEventListener('click', handleLogin);
        document.getElementById('gen-btn').addEventListener('click', generateCode);
        document.getElementById('refresh-btn').addEventListener('click', refreshLogs);

        initAuth();
    </script>
</body>
</html>